---
title: "Pràctica 2"
author: "Jordi Marsol López i Arnau Rafi Cuello"
date: "11/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(plyr)
library(stringr)
library(VIM)
```

## 1. Descripció del dataset. Perquè és important i quina pregunta/problema pretén respondre? 

El conjunt de dades escollit és una enquesta realitzada a estudiants d'educació secundària dels cursos de matemàtiques i llengua portuguesa. El _dataset_ recull diverses respostes  sobre l'àmbit social i escolar dels estudiants. Font: https://www.kaggle.com/uciml/student-alcohol-consumption

La pregunta principal que podem respondre és **quin son els factors que porten a obtenir les millors qualificacions?** També podrem fer altres creuaments de dades que estimem oportuns segons anem veient a l'estudi. 

Els atributs de què està format i les seves característiques son els següents com s'indica a la font original serien:

*  school - student's school (binary: 'GP' - Gabriel Pereira or 'MS' - Mousinho da Silveira)
*  sex - student's sex (binary: 'F' - female or 'M' - male)
*  age - student's age (numeric: from 15 to 22)
*  address - student's home address type (binary: 'U' - urban or 'R' - rural)
*  famsize - family size (binary: 'LE3' - less or equal to 3 or 'GT3' - greater than 3)
*  Pstatus - parent's cohabitation status (binary: 'T' - living together or 'A' - apart)
*  Medu - mother's education (numeric: 0 - none, 1 - primary education (4th grade), 2 – 5th to 9th grade, 3 – secondary education or 4 – higher education)
*  Fedu - father's education (numeric: 0 - none, 1 - primary education (4th grade), 2 – 5th to 9th grade, 3 – secondary education or 4 – higher education)
*  Mjob - mother's job (nominal: 'teacher', 'health' care related, civil 'services' (e.g. administrative or police), 'at_home' or 'other')
*  Fjob - father's job (nominal: 'teacher', 'health' care related, civil 'services' (e.g. administrative or police), 'at_home' or 'other')
*  reason - reason to choose this school (nominal: close to 'home', school 'reputation', 'course' preference or 'other')
*  guardian - student's guardian (nominal: 'mother', 'father' or 'other')
*  traveltime - home to school travel time (numeric: 1 - <15 min., 2 - 15 to 30 min., 3 - 30 min. to 1 hour, or 4 - >1 hour)
*  studytime - weekly study time (numeric: 1 - <2 hours, 2 - 2 to 5 hours, 3 - 5 to 10 hours, or 4 - >10 hours)
*  failures - number of past class failures (numeric: n if 1<=n<3, else 4)
*  schoolsup - extra educational support (binary: yes or no)
*  famsup - family educational support (binary: yes or no)
*  paid - extra paid classes within the course subject (Math or Portuguese) (binary: yes or no)
*  activities - extra-curricular activities (binary: yes or no)
*  nursery - attended nursery school (binary: yes or no)
*  higher - wants to take higher education (binary: yes or no)
*  internet - Internet access at home (binary: yes or no)
*  romantic - with a romantic relationship (binary: yes or no)
*  famrel - quality of family relationships (numeric: from 1 - very bad to 5 - excellent)
*  freetime - free time after school (numeric: from 1 - very low to 5 - very high)
*  goout - going out with friends (numeric: from 1 - very low to 5 - very high)
*  Dalc - workday alcohol consumption (numeric: from 1 - very low to 5 - very high)
*  Walc - weekend alcohol consumption (numeric: from 1 - very low to 5 - very high)
*  health - current health status (numeric: from 1 - very bad to 5 - very good)
*  absences - number of school absences (numeric: from 0 to 93)
*  G1 - first period grade (numeric: from 0 to 20)
*  G2 - second period grade (numeric: from 0 to 20)
*  G3 - final grade (numeric: from 0 to 20, output target)


## 2. Integració i selecció de les dades d’interès a analitzar

El _dataset_ original separa en dos arxius amb els mateixos atributs els estudiants de matemàtiques i els de portuguès.
A la font del _dataset_ es comenta i dona la opció de fusionar els dos conjunts de dades en un de sol amb les dades dels estudiants que estiguin als dos cursos alhora. Tot i no haver un identificador únic d'estudiant si que se'ns proporcionen els camps que haurien de conformar un estudiant com a únic dins el conjunt per poder fer la fusió.

A priori inclourem tots els atributs de la taula ja que tots poden ser susceptibles d'interès per l'anàlisi. Tot i que només els compararem tots exhaustivament en alguns casos com ara l'anàlisi de correlacions, si que els revisarem al procés de neteja.

### Càrrega incial
Carreguem l'arxiu amb les dades i en mostrem un resum de les seves variables

Per maximitzar l'estudi unirem els dos _datasets_ que tenim un de la classe de matemàtiques i l'altre de portuguès i crearem la variable "tipus" per distingir-los, indicant "M" per màtemàtiques o "P" per portuguès.

```{r}
mat <- read.table("student-mat.csv",sep=",",header=TRUE)
por <- read.table("student-por.csv",sep=",",header=TRUE)

tipus <- rep("M",nrow(mat))
mat <- cbind(mat,tipus)
tipus <- rep("P",nrow(por))
por <- cbind(por,tipus)
alumnes <- rbind(mat,por)
str(alumnes)
```
Observem que hi ha variables tan de tipus categòric com numèric. En aquest _dataset_  no hi ha variables amb valor de textos lliures que podrien tenir qualsevol contingut, per tant les que siguin tipus caràcter es poden tractar com a factors.


## 3. Neteja de les dades. 

### 3.1. Les dades contenen zeros o elements buits? Com gestionaries aquests casos?


Seguidament farem un llistat de totes les variables i un recompte dels seus valors únics. No inclouríem aquelles que sabem que o bé no serien ni variables numèriques ni categòriques, com ara identificadors, dates o les que continguin textos lliures, observem en el resum de dades però que no seria el cas i totes poden ser útils.

En la següent funció en R es va fent un recompte de les variables, crearem un arxiu de sortida per a un primer anàlisi exploratori i mostraríem apart el percentatge de variables amb valors buits o "NA"s. La funció seria d'especial interès per altres estudis amb un gran nombre de variables.


```{r}

fila <- data.frame(matrix(ncol = 3, nrow = 0))
colnames(fila) <- c('variable','valor','quants')
taula <- fila

for (x in names(alumnes)){
  fila <- count(alumnes,x)
  fila$tipu <- rep(x,nrow(fila))
  colnames(fila) <- c('valor','quants','variable')
  taula <- rbind(taula,fila)
}

taula <- taula[,c("variable","valor","quants")]
write.csv(taula,"quants_tipus_valors.csv",fileEncoding="UTF-8")
taula.buits <- taula[taula$valor=="" | is.na(taula$valor),]
taula.buits <- cbind(taula.buits,round(as.numeric(taula.buits$quants) / nrow(alumnes) *100,digits=1))
names(taula.buits)[4] <- "percent"
rownames(taula.buits) <- NULL
table(taula.buits)
```
</br>
Descobrim que la taula no té cap valor buit, expressat com a una cadena buida en el cas de les dades tipus caràcter o com a valor NA en les variables numèriques. 

Si veiem el resultat de l'arxiu de sortida obtindríem un resum de quants valors únics hi ha per cada variable. Ens interessa saber quina varietat de valors únics hi ha, així observem que en diverses variables numèriques només hi ha valors del 1 al 5, o del 0 al 20 per tant serien pràcticament categòriques ja que son variables amb un rang molt concret de valors numèrics fixes, igualment segueixen sent numèriques ja que es tracta de puntuacions i per tant es poden ordenar de menor a major o al revés.

Com que hem obtingut un llista de valors únics, revisarem el resultat de la taula de recompte dels valors per veure si hi ha algun valor que pugui ser estrany o fora de la seva categoria, amb un format diferent, mal escrit, etc. Està documentat al _dataset_ original quins valors poden prendre les variables però igualment cal verificar que sigui així. Observem que no hi ha valors erronis ni fora del rang que s'espera que tinguin o valors expressats com a desconeguts. L'única variable que ens fa dubtar es _absences_ ja que podria tenir *valors extrems*.
Donat aquest resultat no serà necessari fer cap imputació de valors ja que les dades son completes.

Al següent pas convertirem les dades de tipus caràcter a factor i en mostrarem un resum numèric de totes elles

```{r}
alumnes <- as.data.frame(unclass(alumnes),stringsAsFactors=TRUE) # no va bé a R convertir-ho a factors abans de la funció anterior
summary(alumnes)
```


### 3.2. Identificació i tractament de valors extrems.

Mostrarem gràfiques tipus _boxplot_ per cadascuna de les variables numèriques per identificar _outliers_ ràpidament i després ens centrarem en la variable _absences_ que és la que veiem que té un valor màxim més elevat i podria contenir valors extrems.

```{r}
par(mfrow=c(2,2), mar=c(2,5,1,1))
for(i in 1:ncol(alumnes)) {
  if (is.integer(alumnes[,i])){
    boxplot(alumnes[,i], main = colnames(alumnes)[i], width = 100,col="cornflowerblue")
  }
}
```

Trobem que de les diverses variables numèriques algunes indiquen possibles valors extrems no obstant considerem que entren dins el rang previsible que puguin tenir i no les exclourem. 

Veiem que les variables G1, G2 i G3 son similars i com que no caldria tractar-les individualment en crearem una de sola amb la mitjana de les tres

```{r}
alumnes$grade_mean <- round(rowMeans(alumnes[,c("G1","G2","G3")]),1)
```

</br>
```{r}
alumnes <- alumnes[!alumnes %in% boxplot.stats(alumnes$absences)$out]
par(mfrow=c(1,2))
boxplot(alumnes$absences,col="cornflowerblue")
hist(alumnes$absences,col="cornflowerblue")
```

Confirmem pel gràfic que la variable _absences_ conté diversos valors extrems que sobresurten bastant. Els aïllem i els mostrem individualment, la resta de variables amb valors extrems son molt pocs i entenem que entren dins dels valors possibles que poden aparèixer.

Aïllem els valors extrems i contem quants apareixen

```{r}
boxplot.stats(alumnes$absences)$out
count(boxplot.stats(alumnes$absences)$out)
```

Tenim que hi ha una cinquantena de valors extrems del total de 1044 registres de dades, així que decidim excloure aquests registres de la mostra per poder fer un anàlisi millor posteriorment. En un possible estudi també es podria analitzar com son de diferents els estudiants amb valors extrems de la resta que no ho son.

Per acabar, eliminem els _outliers_ de la mostra i en tornem a mostrar el gràfic sense aquests.

```{r}
alumnes <- alumnes[!alumnes$absences %in% boxplot.stats(alumnes$absences)$out,]
std.out <- alumnes[alumnes$absences %in% boxplot.stats(alumnes$absences)$out,]
par(mfrow=c(1,2))
boxplot(alumnes$absences,col="cornflowerblue")
hist(alumnes$absences,breaks=10,col="cornflowerblue")
```


